<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Queries</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script><link rel="stylesheet" type="text/css" href="macros.css" /><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/elm.min.js"></script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">workflo/macros</span> <span class="project-version">0.2.63</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="01-types.html"><div class="inner"><span>Type specs</span></div></a></li><li class="depth-1  current"><a href="02-queries.html"><div class="inner"><span>Queries</span></div></a></li><li class="depth-1 "><a href="03-defpermission.html"><div class="inner"><span>Permissions (defpermission)</span></div></a></li><li class="depth-1 "><a href="04-defentity.html"><div class="inner"><span>Entities (defentity)</span></div></a></li><li class="depth-1 "><a href="05-defcommand.html"><div class="inner"><span>Commands (defcommand)</span></div></a></li><li class="depth-1 "><a href="06-defservice.html"><div class="inner"><span>Services (defservice)</span></div></a></li><li class="depth-1 "><a href="07-defview.html"><div class="inner"><span>Views (defview)</span></div></a></li><li class="depth-1 "><a href="08-defscreen.html"><div class="inner"><span>Screens (defscreen)</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>workflo</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>macros</span></div></div></li><li class="depth-3 branch"><a href="workflo.macros.bind.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bind</span></div></a></li><li class="depth-3"><a href="workflo.macros.command.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>command</span></div></a></li><li class="depth-4"><a href="workflo.macros.command.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.config.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>config</span></div></a></li><li class="depth-3"><a href="workflo.macros.entity.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>entity</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.entity.datascript.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datascript</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.entity.datomic.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datomic</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.entity.refs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>refs</span></div></a></li><li class="depth-4"><a href="workflo.macros.entity.schema.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>schema</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.hooks.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>hooks</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.jscomponents.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jscomponents</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.permission.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>permission</span></div></a></li><li class="depth-3"><a href="workflo.macros.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.query.bind.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bind</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.query.om-next.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>om-next</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.query.om-util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>om-util</span></div></a></li><li class="depth-4"><a href="workflo.macros.query.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.registry.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>registry</span></div></a></li><li class="depth-3"><a href="workflo.macros.screen.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>screen</span></div></a></li><li class="depth-4"><a href="workflo.macros.screen.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3"><a href="workflo.macros.service.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>service</span></div></a></li><li class="depth-4"><a href="workflo.macros.service.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>specs</span></div></div></li><li class="depth-4 branch"><a href="workflo.macros.specs.bind.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bind</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.command.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>command</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.conforming-query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>conforming-query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.entity.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>entity</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.om-query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>om-query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.parsed-query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>parsed-query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.permission.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>permission</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.screen.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>screen</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.service.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>service</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.types.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>types</span></div></a></li><li class="depth-4"><a href="workflo.macros.specs.view.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>view</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -393px;"><span class="top" style="height: 402px;"></span><span class="bottom"></span></span><span>util</span></div></div></li><li class="depth-4 branch"><a href="workflo.macros.util.form.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>form</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.util.macro.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>macro</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.util.misc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>misc</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.util.string.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>string</span></div></a></li><li class="depth-4"><a href="workflo.macros.util.symbol.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>symbol</span></div></a></li><li class="depth-3"><a href="workflo.macros.view.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>view</span></div></a></li><li class="depth-4"><a href="workflo.macros.view.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#queries" name="queries"></a>Queries</h1>
<p>Most of the macros provided by <code>workflo/macros</code> involve some sort of query. <code>defentity</code> defines an optional authorization query, <code>defcommand</code> defines a query for additional input data, as does <code>defservice</code>, and <code>defview</code> defines a query for data to display in the view.</p>
<p>All queries use the same query language. This query language is fully specified with <code>clojure.spec</code>, via <code>:workflo.macros.specs.query/query</code>.</p>
<h2><a href="#the-query-language" name="the-query-language"></a>The query language</h2>
<p>The query language used by the macros is based on the <a href="https://github.com/omcljs/om/blob/master/src/main/om/next/impl/parser.cljc#L5">Om Next query language</a>. Its structure is the almost identical but its syntax is very different. What our query language adds in terms of actual functionality is</p>
<ul>
  <li>Aliases</li>
  <li>Query fragments — i.e. re-use of queries defined elsewhere</li>
  <li>Advanced parameterization</li>
</ul>
<h3><a href="#elements-of-a-query" name="elements-of-a-query"></a>Elements of a query</h3>
<p>A query is an interleaved vector of different subqueries, some spanning multiple vector elements. These subqueries can be:</p>
<ul>
  <li><strong>Properties</strong> — e.g. <code>user</code> or <code>post</code>, <code>ui.route</code></li>
  <li><strong>Links</strong> — e.g. <code>[user 100]</code> or <code>[ui.route _]</code></li>
  <li><strong>Joins</strong> — of the form <code>{SOURCE TARGET}</code>, where <code>SOURCE</code> can be either a property  (e.g. <code>user</code>) or a link (e.g. <code>[user 100]</code>)</li>
  <li><strong>Prefixed properties</strong> — e.g. <code>user [name email]</code> or <code>ui.route [url params]</code></li>
  <li><strong>Aliased properties</strong> — e.g. <code>user :as jeff</code> or <code>ui.route :as current-route</code></li>
  <li><strong>Parameterizations</strong> – of the form <code>(QUERY PARAMS)</code>, where <code>QUERY</code> is either a  property, an aliased property, a link or a join, and <code>PARAMS</code> is a parameter  map (see the section about query parameters below)</li>
  <li><strong>Fragments</strong> — e.g. <code>...route-query</code> or <code>...user-query</code></li>
</ul>
<p>And since queries are Clojure data structures, they can include comments anywhere.</p>
<h3><a href="#example-queries" name="example-queries"></a>Example queries</h3>
<p>A query for the name and email address of a user with a specific <code>:workflo/id</code>:</p>
<pre><code class="clojure">[({user [workflo [id] user [name email]]}
  {workflo/id "some-id"})]
</code></pre>
<p>This query is identical to the following Om Next query:</p>
<pre><code class="clojure">[({:user [:workflo/id :user/name :user/email]}
  {:workflo/id "some-id"})]
</code></pre>
<p>A query for all users that have the first name <code>Linda</code>, including all posts they have written, sorted by their last names, plus the post with the ID with the value <code>"foo"</code>:</p>
<pre><code class="clojure">[(;; The subquery for the users
  {users [workflo [id]
          user [first-name
                last-name
                {posts [workflo [id]
                        post [title content]]}]]}

  ;; An alias for these users
  :as all-lindas

  ;; The query parameters
  {user/first-name "Linda"
   sort/attr :user/last-name})
 
 {[user "foo"]}]
</code></pre>
<p>This query is equivalent to the following Om Next query, only adding some meta data for the alias:</p>
<pre><code class="clojure">[({:users [:workflo/id
           :user/first-name
           :user/last-name
           {:user/posts [:workflo/id
                         :post/title
                         :post/content]}]}
  {:user/first-name "Linda"
   :sort/attr :user/last-name})]
</code></pre>
<h3><a href="#query-parameters" name="query-parameters"></a>Query parameters</h3>
<p>Each query parameter is represented by a key-value pair in the parameter map of a parameterized query. The key can take two forms:</p>
<ol>
  <li>a parameter name — a symbol like <code>foo</code>, <code>user/name</code> or <code>workflo/id</code></li>
  <li>a parameter path — a vector of symbols, like <code>[user/organization workflo/id]</code>  or <code>[post/blog blog/author author/name]</code></li>
</ol>
<p>The second form is also called <strong>deep parameterization</strong>, as it allows to match properties deep inside an entity and its relationships against the value of a parameter.</p>
<p>The value of a parameter can take three forms:</p>
<ol>
  <li>a literal value — e.g. <code>"Linda"</code>, <code>10</code> or <code>:foo/bar</code></li>
  <li>a variable — e.g. <code>?first-name</code>, <code>?id</code> or <code>?user</code></li>
  <li>a variable path — a vector of variables e.g. <code>[?url ?params ?user]</code></li>
</ol>
<p>How these variables are resolved depends on the situation. Various of the macros define functions that take in data and bind query parameters against this data. In these cases a variable path is similar to a call to <code>get-in</code>, allowing to extract values from deep inside a data structure.</p>
<p>For example, given the input data</p>
<pre><code>{:url {:params {:user "123"}}}
</code></pre>
<p>the variable path <code>[?url ?params ?user]</code> would be resolved to <code>"123"</code> by following the keys <code>:url</code>, <code>:params</code> and <code>:user</code>.</p>
<h2><a href="#api-documentation-utilities" name="api-documentation-utilities"></a>API documentation / utilities</h2>
<p>The macros come with various utilities for parsing queries into an AST, binding query parameters against data, translating queries to Om Next queries, creating bindings for query results in code that consumes them and much more.</p>
<p>The following is a list of pointers to the API documentation for all query utilities.</p>
<ul>
  <li><a href="workflo.macros.bind.html">workflo.macros.bind</a>
    <ul>
      <li>Create local bindings for query results (used for binding query  results in macro function bodies)</li>
    </ul>
  </li>
  <li><a href="workflo.macros.query.html">workflo.macros.query</a>
    <ul>
      <li>Parse queries into an AST</li>
      <li>Conform queries using <code>clojure.spec</code></li>
      <li>Bind query parameters</li>
    </ul>
  </li>
  <li><a href="workflo.macros.query.bind.html">workflo.macros.query.bind</a>
    <ul>
      <li>Resolve variables and variable paths from query parameters:  <a href="workflo.macros.query.bind.html">workflo.macros.query.bind</a></li>
    </ul>
  </li>
  <li><a href="workflo.macros.query.om-next.html">workflo.macros.query.om-next</a>
    <ul>
      <li>Convert query ASTs to Om Next queries</li>
      <li>Split queries (with potential conflicts) into minimal sequences  of non-conflicting queries (useful for sending queries to  backends)</li>
    </ul>
  </li>
  <li><a href="workflo.macros.query.om-util.html">workflo.macros.query.om-util</a>
    <ul>
      <li>Internal utilities for working with Om Next queries</li>
    </ul>
  </li>
  <li><a href="workflo.macros.query.util.html">workflo.macros.query.util</a>
    <ul>
      <li>Internal utilities for working with queries.</li>
    </ul>
  </li>
</ul></div></div></div></body></html>