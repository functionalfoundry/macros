<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Services (defservice)</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script><link rel="stylesheet" type="text/css" href="macros.css" /><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/elm.min.js"></script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">workflo/macros</span> <span class="project-version"></span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="01-types.html"><div class="inner"><span>Type specs</span></div></a></li><li class="depth-1 "><a href="02-queries.html"><div class="inner"><span>Queries</span></div></a></li><li class="depth-1 "><a href="03-defpermission.html"><div class="inner"><span>Permissions (defpermission)</span></div></a></li><li class="depth-1 "><a href="04-defentity.html"><div class="inner"><span>Entities (defentity)</span></div></a></li><li class="depth-1 "><a href="05-defcommand.html"><div class="inner"><span>Commands (defcommand)</span></div></a></li><li class="depth-1  current"><a href="06-defservice.html"><div class="inner"><span>Services (defservice)</span></div></a></li><li class="depth-1 "><a href="07-defview.html"><div class="inner"><span>Views (defview)</span></div></a></li><li class="depth-1 "><a href="08-defscreen.html"><div class="inner"><span>Screens (defscreen)</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>workflo</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>macros</span></div></div></li><li class="depth-3 branch"><a href="workflo.macros.bind.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bind</span></div></a></li><li class="depth-3"><a href="workflo.macros.command.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>command</span></div></a></li><li class="depth-4"><a href="workflo.macros.command.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.config.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>config</span></div></a></li><li class="depth-3"><a href="workflo.macros.entity.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>entity</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.entity.datascript.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datascript</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.entity.datomic.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datomic</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.entity.refs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>refs</span></div></a></li><li class="depth-4"><a href="workflo.macros.entity.schema.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>schema</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.hooks.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>hooks</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.jscomponents.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jscomponents</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.permission.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>permission</span></div></a></li><li class="depth-3"><a href="workflo.macros.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.query.bind.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bind</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.query.om-next.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>om-next</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.query.om-util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>om-util</span></div></a></li><li class="depth-4"><a href="workflo.macros.query.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.registry.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>registry</span></div></a></li><li class="depth-3"><a href="workflo.macros.screen.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>screen</span></div></a></li><li class="depth-4"><a href="workflo.macros.screen.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3"><a href="workflo.macros.service.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>service</span></div></a></li><li class="depth-4"><a href="workflo.macros.service.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>specs</span></div></div></li><li class="depth-4 branch"><a href="workflo.macros.specs.bind.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bind</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.command.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>command</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.conforming-query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>conforming-query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.entity.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>entity</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.om-query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>om-query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.parsed-query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>parsed-query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.permission.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>permission</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.screen.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>screen</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.service.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>service</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.types.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>types</span></div></a></li><li class="depth-4"><a href="workflo.macros.specs.view.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>view</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -393px;"><span class="top" style="height: 402px;"></span><span class="bottom"></span></span><span>util</span></div></div></li><li class="depth-4 branch"><a href="workflo.macros.util.form.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>form</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.util.macro.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>macro</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.util.misc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>misc</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.util.string.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>string</span></div></a></li><li class="depth-4"><a href="workflo.macros.util.symbol.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>symbol</span></div></a></li><li class="depth-3"><a href="workflo.macros.view.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>view</span></div></a></li><li class="depth-4"><a href="workflo.macros.view.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#services-defservice-" name="services-defservice-"></a>Services (defservice)</h1>
<p>In <code>workflo/macros</code>, services are components in the system that data (events, instructions or any other data) can be delivered to for processing. Unlike the reducer-flavored <a href="05-defcommand.html">commands</a>, services are (or can be) stateful and are expected to (but not required to) generate side-effects as part of their processing.</p>
<p>Like commands, services can—as part of their processing—emit data for the system to act on further.</p>
<p>In a <em>(Screens-)Views-Commands-Services</em> architecture, screens might render views, views might trigger commands, commands might emit to services and services might emit side-effects and updates to the app state so that the screens/views update.</p>
<p>Some key features of services include:</p>
<ul>
  <li><strong>Service components</strong> — <code>defservice</code> automatically creates  <a href="https://github.com/stuartsierra/component">components</a> for each service,  allowing services to integrate seeminglessly in most Clojure systems;  what is more, all running instances of service components are  stored in a global registry so that they can be looked up by the  service name (e.g. for data deliveries)</li>
  <li><strong>Dependencies</strong> — services can declare that they depend on other  services; this can be used by frameworks such as  <a href="https://github.com/danielsz/system">system</a> to start service  components in the right order and inject depenencies into dependent  service components.</li>
  <li><strong>Service queries</strong> — like <a href="05-defcommand.html">commands</a>, services support  a query to fetch additional information before processing incoming data</li>
  <li><strong>Service registry</strong> — services defined with <code>defservice</code> are stored  in a global registry, from where they can be looked up at any time using  their name</li>
  <li><strong>Multi-service dispatching</strong> — data in the form of a collection  of <code>[SERVICE_NAME DATA]</code> (e.g. a key/value map or vector of tuples)  can be delivered to multiple services at once by dispatching on  the service names in the tuples; this is a handy feature when forwarding  data emitted from <a href="05-defcommand.html">commands</a> to services</li>
  <li><strong>Delayed and debounced delivery</strong> — services support hints that  allow to delay deliveries by a certain time or to debounce deliveries  (either all per service or based on the contents of the delivered data)</li>
</ul>
<h2><a href="#usage" name="usage"></a>Usage</h2>
<h3><a href="#general-structure" name="general-structure"></a>General structure</h3>
<pre><code class="clojure">(defservice &lt;name&gt;
  "description"        ; Optional
  (hints [...])        ; Optional
  (dependencies [...]) ; Optional
  (query ...)          ; Optional
  (spec ...)           ; Optional (spec for delivery data)
  (start ...)          ; Optional (executed when the service component starts)
  (stop ...)           ; Optional (executed when the service component stops)
  (process ...)        ; Optional (handles data deliveries)
  )
</code></pre>
<h3><a href="#simple-example" name="simple-example"></a>Simple example</h3>
<pre><code class="clojure">(require '[clojure.spec.alpha :as s]
         '[com.stuartsierra.component :as component]
         '[workflo.macros.service :as services :refer [defservice]])


;; Specs for delivery data

(s/def ::record (s/keys :req [:db/id]))

(s/def ::create-operation (s/tuple #{:create} ::record))
(s/def ::update-operation (s/tuple #{:update} ::record))
(s/def ::delete-operation (s/tuple #{:delete} ::record))

(s/def ::operations
  (s/or :create ::create-operation
        :update ::update-operation
        :delete ::delete-operation))


;; DB service

(defservice db
  "A very simple database service."
  (spec
    (s/coll-of ::operations :kind vector?))
  (start
    (println "Starting db")
    (assoc this :store (atom {})))
  (stop
    (println "Stopping db")
    (dissoc this :store))
  (process
    (doseq [[op op-data] data]
      (let [id (get op-data :db/id)]
      (case op
        :create (swap! (get this :store) assoc id op-data)
        :update (swap! (get this :store) update id merge op-data)
        :delete (swap! (get this  :store) dissoc id))))))


;; Create and start a DB service component

(-&gt; (services/new-service-component 'db {:optional :config})
    (component/start))


;; Deliver some data

(services/deliver-to-services!
  {:db [[:create {:db/id 1 :user/name "John"}]
        [:create {:db/id 2 :user/name "Linda"}]
        [:update {:db/id 2 :user/email "linda@email.com"}]
        [:delete {:db/id 1}]]})


;; Obtain the service component and print its store

(-&gt; (services/resolve-service-component 'db)
    (get :store)
    (deref)
    (println))

;; -&gt; {2 {:db/id 2 :user/name "Linda" :user/email "linda@email.com"}}
</code></pre>
<h2><a href="#api-documentation" name="api-documentation"></a>API documentation</h2>
<p>The following is a list of pointers to namespaces that are related to services:</p>
<ul>
  <li><a href="workflo.macros.service.html">workflo.macros.service</a>
    <ul>
      <li>The <code>defservice</code> macro</li>
      <li>Service registry</li>
      <li>Service component creation and registry</li>
      <li>Service delivery</li>
      <li>Service hooks</li>
    </ul>
  </li>
  <li><a href="workflo.macros.specs.service.html">workflo.macros.specs.service</a>
    <ul>
      <li>Specs for <code>defservice</code> arguments</li>
    </ul>
  </li>
</ul></div></div></div></body></html>