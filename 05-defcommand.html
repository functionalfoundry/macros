<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Commands (defcommand)</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script><link rel="stylesheet" type="text/css" href="macros.css" /><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/elm.min.js"></script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">workflo/macros</span> <span class="project-version">0.2.63</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="01-types.html"><div class="inner"><span>Type specs</span></div></a></li><li class="depth-1 "><a href="02-queries.html"><div class="inner"><span>Queries</span></div></a></li><li class="depth-1 "><a href="03-defpermission.html"><div class="inner"><span>Permissions (defpermission)</span></div></a></li><li class="depth-1 "><a href="04-defentity.html"><div class="inner"><span>Entities (defentity)</span></div></a></li><li class="depth-1  current"><a href="05-defcommand.html"><div class="inner"><span>Commands (defcommand)</span></div></a></li><li class="depth-1 "><a href="06-defservice.html"><div class="inner"><span>Services (defservice)</span></div></a></li><li class="depth-1 "><a href="07-defview.html"><div class="inner"><span>Views (defview)</span></div></a></li><li class="depth-1 "><a href="08-defscreen.html"><div class="inner"><span>Screens (defscreen)</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>workflo</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>macros</span></div></div></li><li class="depth-3 branch"><a href="workflo.macros.bind.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bind</span></div></a></li><li class="depth-3"><a href="workflo.macros.command.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>command</span></div></a></li><li class="depth-4"><a href="workflo.macros.command.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.config.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>config</span></div></a></li><li class="depth-3"><a href="workflo.macros.entity.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>entity</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.entity.datascript.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datascript</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.entity.datomic.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datomic</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.entity.refs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>refs</span></div></a></li><li class="depth-4"><a href="workflo.macros.entity.schema.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>schema</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.hooks.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>hooks</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.jscomponents.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jscomponents</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.permission.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>permission</span></div></a></li><li class="depth-3"><a href="workflo.macros.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.query.bind.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bind</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.query.om-next.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>om-next</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.query.om-util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>om-util</span></div></a></li><li class="depth-4"><a href="workflo.macros.query.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3 branch"><a href="workflo.macros.registry.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>registry</span></div></a></li><li class="depth-3"><a href="workflo.macros.screen.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>screen</span></div></a></li><li class="depth-4"><a href="workflo.macros.screen.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3"><a href="workflo.macros.service.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>service</span></div></a></li><li class="depth-4"><a href="workflo.macros.service.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>specs</span></div></div></li><li class="depth-4 branch"><a href="workflo.macros.specs.bind.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bind</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.command.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>command</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.conforming-query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>conforming-query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.entity.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>entity</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.om-query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>om-query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.parsed-query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>parsed-query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.permission.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>permission</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.screen.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>screen</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.service.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>service</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.specs.types.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>types</span></div></a></li><li class="depth-4"><a href="workflo.macros.specs.view.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>view</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -393px;"><span class="top" style="height: 402px;"></span><span class="bottom"></span></span><span>util</span></div></div></li><li class="depth-4 branch"><a href="workflo.macros.util.form.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>form</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.util.macro.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>macro</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.util.misc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>misc</span></div></a></li><li class="depth-4 branch"><a href="workflo.macros.util.string.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>string</span></div></a></li><li class="depth-4"><a href="workflo.macros.util.symbol.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>symbol</span></div></a></li><li class="depth-3"><a href="workflo.macros.view.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>view</span></div></a></li><li class="depth-4"><a href="workflo.macros.view.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#commands-defcommand-" name="commands-defcommand-"></a>Commands (defcommand)</h1>
<p>Commands represent actions that can be performed in a system, either triggered by the user or by any other part of the system.</p>
<p>A command takes in input data (the payload) and optionally asks the system to run a query to fetch additional data required for it to run. It then executes code and eventually emits data, which typically would be delivered to registered services (see <a href="06-defservice.html">Services</a> for more information on those.</p>
<p>Commands are defined and registered with the <code>defcommand</code> macro. Some of the key features of commands are:</p>
<ul>
  <li><strong>Interface similar to reducers</strong> — commands are designed to encourage  concise, side-effect-free, self-contained code; see the section about  the reducing nature of commands below</li>
  <li><strong>Queries, parameterized using command input data</strong> — every command  has an optional <a href="02-queries.html">query</a> to fetch additional data;  values of query parameters are resolved using the data passed to  the command</li>
  <li><strong>Local bindings for query results</strong> — query results are bound to  names in the command execution scope automatically</li>
  <li><strong>Authorization</strong> — like with <a href="04-defentity.html">entities</a>, support for  authorization comes built-in through an auth query and an auth function</li>
  <li><strong>Command registry</strong> — all commands are stored in a registry from  which they can be looked up again by their names at any time</li>
</ul>
<h2><a href="#commands-are-like-reducers" name="commands-are-like-reducers"></a>Commands are like reducers</h2>
<p>Commands can be thought of as being similar to reducers of the form</p>
<pre><code class="elm">Reducer :: (State, Data) -&gt; State
</code></pre>
<p>with their query and output data added into the mix as follows:</p>
<pre><code class="elm">BindQuery      :: UnboundQuery -&gt; Data -&gt; BoundQuery

-- In reality, how queries are executed is entirely up to you
RunQuery       :: State -&gt; BoundQuery -&gt; QueryResults

-- Command implementations are, ideally, free of side-effects
Implementation :: QueryResults -&gt; Data -&gt; EmitData

-- Rough outline of how commands are executed
RunCommand     :: State -&gt; UnboundQuery -&gt; Data -&gt; Implementation -&gt; EmitData
RunCommand state, unboundQuery, data, implementation =
  implementation (RunQuery state (BindQuery unboundQuery data)) data
</code></pre>
<h2><a href="#usage" name="usage"></a>Usage</h2>
<h3><a href="#general-structure" name="general-structure"></a>General structure</h3>
<pre><code class="clojure">(require '[workflo.macros.command :refer [defcommand]])

(defcommand &lt;name&gt;
  "description"     ; Optional
  (hints [...])     ; Optional
  (spec ...)        ; Optional (clojure.spec for the input data)
  (query ...)       ; Optional
  (auth-query ...)  ; Optional
  (auth ...)        ; Optional
  ...               ; Optional (arbitrary (foo ...) forms)
  (emit ...)        ; Required (the implementation of the code)
  )
</code></pre>
<h3><a href="#simple-example" name="simple-example"></a>Simple example</h3>
<pre><code class="clojure">(require '[clojure.spec.alpha :as s]
         '[workflo.macros.command :as commands :refer [defcommand]]
         '[workflo.macros.entity :refer [defentity]]
         '[workflo.macros.specs.types :as types])

        
;; User entity (this establishes specs for a user's attributes)

(s/def :user/name ::types/string)
(s/def :user/email ::types/string)

(defentity user
  (spec
    (s/keys :req [:workflo/id
                  :user/name
                  :user/email])))


;; Specs for the command input data

(s/def :create-user/user (get user :spec)) ; Reuse the user spec here
(s/def :create-user/timestamp ::types/instant)


;; Implementation of a command to create new users

(defcommand create-user
  "Creates a user and sends them a welcome email."
  (spec
    ;; The command expects a user and a timestamp
    (s/keys :req-un [:create-user/user
                     :create-user/timestamp]))
  (query
    ;; Query all existing users with their emails
    [{users [user [email]]} :as existing-users])
  (emit
    (let [;; Extract the new user from the input data
          new-user          (get data :user)
          ;; Define a predicate for checking whether the user already exists
          matches-new-user? (fn [existing-user]
                              (= (get existing-user :user/email) 
                                 (get new-user :user/email)))]
      (if (some matches-new-user? existing-user)
        ;; Emit nothing if the user exists
        {}
        ;; Otherwise, create the user in the database and send an email
        ;; What you emit here is entirely up to you
        {:db [[:create new-user]]
         :email [{:from "Great App &lt;info@great-app.com&gt;"
                  :to (get new-user :user/email)
                  :subject (str "Welcome to Great App, "
                                (get new-user :user/email)}]})))))


;; Run the command

(commands/run-command! 'create-user
                       {:user {:workflo/id "..."
                               :user/name "John"
                               :user/email "john@doe.org"}
                        :timestamp (java.util.Date.now.)})

;; -&gt; {:db [[:create {:workflo/id "..."
;;                    :user/name "John"
;;                    :user/email "john@doe.org"}]]
;;     :email [{:from "Great App &lt;info@great-app.com&gt;"
;;              :to "john@doe.org"
;;              :subject (str "Welcome to Great App, John")}]}


;; Run the command again

(commands/run-command! 'create-user
                       {:user {:workflo/id "..."
                               :user/name "John"
                               :user/email "john@doe.org"}
                        :timestamp (java.util.Date.now.)})

;; -&gt; {}
</code></pre>
<h2><a href="#api-documentation" name="api-documentation"></a>API documentation</h2>
<p>The following is a list of pointers to namespaces related to commands:</p>
<ul>
  <li><a href="workflo.macros.command.html">workflo.macros.command</a>
    <ul>
      <li>The <code>defcommand</code> macro</li>
      <li>Command execution</li>
      <li>Command registry</li>
      <li>Command hooks</li>
    </ul>
  </li>
  <li><a href="workflo.macros.command.util.html">workflo.macros.command.util</a>
    <ul>
      <li>Internal utilities for <code>defcommand</code></li>
    </ul>
  </li>
  <li><a href="workflo.macros.specs.command.html">workflo.macros.specs.command</a>
    <ul>
      <li>Specs for <code>defcommand</code> arguments</li>
    </ul>
  </li>
</ul></div></div></div></body></html>